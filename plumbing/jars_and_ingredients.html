<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Jars 和配料 - Salsa（中文介绍）</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
                <link rel="stylesheet" href="../mermaid.css">
                <link rel="stylesheet" href="../theme/pagetoc.css">
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../about_salsa.html"><strong aria-hidden="true">1.</strong> 关于 salsa</a></li><li class="chapter-item expanded affix "><li class="part-title">如何使用 Salsa</li><li class="chapter-item expanded "><a href="../overview.html"><strong aria-hidden="true">2.</strong> 概述</a></li><li class="chapter-item expanded "><a href="../tutorial.html"><strong aria-hidden="true">3.</strong> 教程： calc 语言</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tutorial/structure.html"><strong aria-hidden="true">3.1.</strong> 基本结构</a></li><li class="chapter-item expanded "><a href="../tutorial/jar.html"><strong aria-hidden="true">3.2.</strong> Jars 和数据库</a></li><li class="chapter-item expanded "><a href="../tutorial/db.html"><strong aria-hidden="true">3.3.</strong> 定义数据库结构体</a></li><li class="chapter-item expanded "><a href="../tutorial/ir.html"><strong aria-hidden="true">3.4.</strong> 定义 IR：各种 Salsa 结构体</a></li><li class="chapter-item expanded "><a href="../tutorial/parser.html"><strong aria-hidden="true">3.5.</strong> 定义解析器：存储函数的值和输入</a></li><li class="chapter-item expanded "><a href="../tutorial/accumulators.html"><strong aria-hidden="true">3.6.</strong> 定义解析器：报告错误</a></li><li class="chapter-item expanded "><a href="../tutorial/debug.html"><strong aria-hidden="true">3.7.</strong> 定义解析器：debug 与测试</a></li><li class="chapter-item expanded "><a href="../tutorial/checker.html"><strong aria-hidden="true">3.8.</strong> Defining the checker</a></li><li class="chapter-item expanded "><a href="../tutorial/interpreter.html"><strong aria-hidden="true">3.9.</strong> Defining the interpreter</a></li></ol></li><li class="chapter-item expanded "><a href="../reference.html"><strong aria-hidden="true">4.</strong> 参考</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../reference/algorithm.html"><strong aria-hidden="true">4.1.</strong> 算法</a></li></ol></li><li class="chapter-item expanded "><a href="../common_patterns.html"><strong aria-hidden="true">5.</strong> 模式</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../common_patterns/selection.html"><strong aria-hidden="true">5.1.</strong> 选择</a></li><li class="chapter-item expanded "><a href="../common_patterns/on_demand_inputs.html"><strong aria-hidden="true">5.2.</strong> 按需（惰性）输入</a></li></ol></li><li class="chapter-item expanded "><a href="../tuning.html"><strong aria-hidden="true">6.</strong> 调参</a></li><li class="chapter-item expanded "><a href="../cycles.html"><strong aria-hidden="true">7.</strong> 处理循环</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cycles/fallback.html"><strong aria-hidden="true">7.1.</strong> 通过回退恢复</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Salsa 内部如何工作</li><li class="chapter-item expanded "><a href="../how_salsa_works.html"><strong aria-hidden="true">8.</strong> Salsa 如何工作</a></li><li class="chapter-item expanded "><a href="../videos.html"><strong aria-hidden="true">9.</strong> 视频介绍</a></li><li class="chapter-item expanded "><a href="../plumbing.html"><strong aria-hidden="true">10.</strong> 管道</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../plumbing/jars_and_ingredients.html" class="active"><strong aria-hidden="true">10.1.</strong> Jars 和配料</a></li><li class="chapter-item expanded "><a href="../plumbing/database_and_runtime.html"><strong aria-hidden="true">10.2.</strong> 数据库和运行时</a></li><li class="chapter-item expanded "><a href="../plumbing/query_ops.html"><strong aria-hidden="true">10.3.</strong> 查询操作</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../plumbing/maybe_changed_after.html"><strong aria-hidden="true">10.3.1.</strong> maybe_changed_after</a></li><li class="chapter-item expanded "><a href="../plumbing/fetch.html"><strong aria-hidden="true">10.3.2.</strong> fetch</a></li><li class="chapter-item expanded "><a href="../plumbing/derived_flowchart.html"><strong aria-hidden="true">10.3.3.</strong> 派生查询流程图</a></li><li class="chapter-item expanded "><a href="../plumbing/cycles.html"><strong aria-hidden="true">10.3.4.</strong> 处理循环</a></li></ol></li><li class="chapter-item expanded "><a href="../plumbing/terminology.html"><strong aria-hidden="true">10.4.</strong> 术语</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../plumbing/terminology/backdate.html"><strong aria-hidden="true">10.4.1.</strong> Backdate</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/changed_at.html"><strong aria-hidden="true">10.4.2.</strong> Changed at</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/dependency.html"><strong aria-hidden="true">10.4.3.</strong> Dependency</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/derived_query.html"><strong aria-hidden="true">10.4.4.</strong> Derived query</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/durability.html"><strong aria-hidden="true">10.4.5.</strong> Durability</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/input_query.html"><strong aria-hidden="true">10.4.6.</strong> Input query</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/ingredient.html"><strong aria-hidden="true">10.4.7.</strong> Ingredient</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/LRU.html"><strong aria-hidden="true">10.4.8.</strong> LRU</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/memo.html"><strong aria-hidden="true">10.4.9.</strong> Memo</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/query.html"><strong aria-hidden="true">10.4.10.</strong> Query</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/query_function.html"><strong aria-hidden="true">10.4.11.</strong> Query function</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/revision.html"><strong aria-hidden="true">10.4.12.</strong> Revision</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/salsa_item.html"><strong aria-hidden="true">10.4.13.</strong> Salsa item</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/salsa_struct.html"><strong aria-hidden="true">10.4.14.</strong> Salsa struct</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/untracked.html"><strong aria-hidden="true">10.4.15.</strong> Untracked dependency</a></li><li class="chapter-item expanded "><a href="../plumbing/terminology/verified.html"><strong aria-hidden="true">10.4.16.</strong> Verified</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">附录</li><li class="chapter-item expanded "><a href="../meta.html"><strong aria-hidden="true">11.</strong> 关于这本书本身</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Salsa（中文介绍）</h1>

                    <div class="right-buttons">
                                                                        <a href="https://github.com/zjp-CN/salsa/tree/Chinese" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/zjp-CN/salsa/edit/Chinese/book/src/plumbing/jars_and_ingredients.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <!-- master#657b856 --->
<h1 id="jar-和配料"><a class="header" href="#jar-和配料">Jar 和配料</a></h1>
<blockquote>
<p>⚠️ <strong>Salsa 仍在进展中</strong> ⚠️</p>
<p>本页描述了未发布的 Salsa 2022 版本，该版本与旧版本大不相同。此处的代码有效，但仅在
github 和 <code>salsa-2022</code> crate 中可用。</p>
</blockquote>
<p>本节介绍 Salsa 中的数据是如何组织的，以及 Salsa 条目(items) 之间如何联系起来（例如，依赖条目跟踪）。</p>
<h2 id="salsa-条目和配料"><a class="header" href="#salsa-条目和配料">Salsa 条目和配料</a></h2>
<p>Salsa 条目是指可以包括在 Jar 中、带有 Salsa 属性宏标注的条目。例如，跟踪函数是一个 Salsa 条目：</p>
<pre><code class="language-rust ignore">#[salsa::tracked]
fn foo(db: &amp;dyn Db, input: MyInput) { }
</code></pre>
<p>... Salsa 输入也是如此...</p>
<pre><code class="language-rust ignore">#[salsa::input]
struct MyInput { }
</code></pre>
<p>...或跟踪结构：</p>
<pre><code class="language-rust ignore">#[salsa::tracked]
struct MyStruct { }
</code></pre>
<p>每个 Salsa 条目在运行时都需要特定的数据才能运行。这些数据被称为 “<strong>配料</strong>” (ingredients)。</p>
<p>大多数 Salsa 条目只产生一种配料，但有时会产生不止一种配料。</p>
<p>例如，跟踪函数会生成一个 <a href="https://github.com/salsa-rs/salsa/blob/becaade31e6ebc58cd0505fc1ee4b8df1f39f7de/components/salsa-2022/src/function.rs#L42"><code>FunctionIngredient</code></a>。但跟踪结构会生成几个配料，一个用于结构本身的 
<a href="https://github.com/salsa-rs/salsa/blob/becaade31e6ebc58cd0505fc1ee4b8df1f39f7de/components/salsa-2022/src/tracked_struct.rs#L18"><code>TrackedStructIngredient</code></a>，一个用于每个值字段的 <a href="https://github.com/salsa-rs/salsa/blob/becaade31e6ebc58cd0505fc1ee4b8df1f39f7de/components/salsa-2022/src/function.rs#L42"><code>FunctionIngredient</code></a>。</p>
<h3 id="配料定义了核心逻辑"><a class="header" href="#配料定义了核心逻辑">配料定义了核心逻辑</a></h3>
<p>大多数有趣的 Salsa 代码都存在于这些配料中。例如，当你创建新的跟踪结构，会调用方法 <a href="https://github.com/salsa-rs/salsa/blob/becaade31e6ebc58cd0505fc1ee4b8df1f39f7de/components/salsa-2022/src/tracked_struct.rs#L76"><code>TrackedStruct::new_struct</code></a>，它负责确定跟踪结构的 id。</p>
<p>类似地，当你调用一个跟踪函数，它被转换为对 <a href="https://github.com/salsa-rs/salsa/blob/becaade31e6ebc58cd0505fc1ee4b8df1f39f7de/components/salsa-2022/src/function/fetch.rs#L15"><code>TrackedFunction::fetch</code></a> 的调用，从而决定是否有有效的记忆值要返回，或者该函数是否必须执行。</p>
<h3 id="ingredient-trait"><a class="header" href="#ingredient-trait"><code>Ingredient</code> trait</a></h3>
<p>每个配料都实现了 <a href="https://github.com/salsa-rs/salsa/blob/becaade31e6ebc58cd0505fc1ee4b8df1f39f7de/components/salsa-2022/src/ingredient.rs#L15"><code>Ingredient&lt;DB&gt;</code></a> trait ，该 trait 定义了各种配料支持的泛型操作。</p>
<p>例如，可以使用 <code>maybe_changed_after</code> 方法来检查自给定版本以来，存储在配料中的某些特定数据是否发生了更改：</p>
<p>下面我们将看到，每个数据库 <code>DB</code> 都能够获取一个 <code>IngredientIndex</code>，并用它来获取相应的配料 <code>&amp;dyn Ingredient&lt;DB&gt;</code>。</p>
<p>这允许数据库对已索引的配料执行泛型操作，而无需确切知道该配料的类型。</p>
<h3 id="jar-是各种配料的集合"><a class="header" href="#jar-是各种配料的集合">Jar 是各种配料的集合</a></h3>
<p>当你声明一个 Salsa 的 jar 时，需列出了该 jar 中包含的每个 Salsa 条目：</p>
<pre><code class="language-rust ignore">#[salsa::jar]
struct Jar(
    foo,
    MyInput,
    MyStruct
);
</code></pre>
<p>这将展开成如下所示的结构体：</p>
<pre><code class="language-rust ignore">struct Jar(
    &lt;foo as IngredientsFor&gt;::Ingredient,
    &lt;MyInput as IngredientsFor&gt;::Ingredient,
    &lt;MyStruct as IngredientsFor&gt;::Ingredient,
)
</code></pre>
<p><code>IngredientsFor</code> trait 用于定义某些 Salsa 条目所需的配料，例如跟踪函数 <code>foo</code> 或跟踪结构 <code>MyInput</code>。</p>
<p>每个 Salsa 条目都定义了一个类型 <code>I</code>，因此 <code>&lt;I as IngredientsFor&gt;::Ingredient</code> 提供了 <code>I</code> 所需的配料。</p>
<h3 id="数据库是一组-jars"><a class="header" href="#数据库是一组-jars">数据库是一组 Jars</a></h3>
<p>Salsa 的数据库存储最终归结为一组 Jars 结构体，其中每个 Jar 结构体本身包含 Salsa 条目的配料。</p>
<p>因此，数据库可以被认为是一个配料列表，尽管该列表被组织成两级层次结构。</p>
<p>这种两级层次结构的原因是它允许单独的编译和私有化。</p>
<p>罗列 Jars 的 crate 不必知道 Jar 的内容即可将 Jar 结构体嵌入到数据库中。 Jar 中出现的某些类型可能是另一个结构体的私有类型。</p>
<h3 id="hasjars-trait-和-jars-类型"><a class="header" href="#hasjars-trait-和-jars-类型"><code>HasJars</code> trait 和 <code>Jars</code> 类型</a></h3>
<p>每个 Salsa 数据库都实现了 <code>HasJars</code> trait，该 trait 由 <code>salsa::db</code> 过程宏生成。</p>
<p>此外，<code>HarJars</code> trait 还定义了一个映射到 trait 中的 Jars 元组的 <code>Jars</code> 关联类型。</p>
<p>例如，给定一个这样的数据库...</p>
<pre><code class="language-rust ignore">#[salsa::db(Jar1, ..., JarN)]
struct MyDatabase {
    storage: salsa::Storage&lt;Self&gt;
}
</code></pre>
<p><code>salsa::db</code> 宏将生成一个包含 <code>type Jars = (Jar1, ..., JarN)</code> 的 <code>HasJars</code> 实现。</p>
<pre><code class="language-rust ignore">        impl salsa::storage::HasJars for #db {
            type Jars = (#(#jar_paths,)*);
</code></pre>
<p>反过来说，<code>salsa::Storage&lt;DB&gt;</code> 类型最终包含一个嵌入 <code>DB::Jars</code> 的 <code>Shared</code> 结构体，从而嵌入每个 Jar 的所有数据。</p>
<h3 id="配料索引"><a class="header" href="#配料索引">配料索引</a></h3>
<p>在初始化期间，数据库中的每个配料都被分配了一个唯一的索引，称为 <a href="https://github.com/salsa-rs/salsa/blob/becaade31e6ebc58cd0505fc1ee4b8df1f39f7de/components/salsa-2022/src/routes.rs#L5-L9"><code>IngredientIndex</code></a>。这是一个 32 位数字，用于标识特定 Jar 中的特定配料。</p>
<h3 id="路线"><a class="header" href="#路线">路线</a></h3>
<p>除了索引，数据库中的每一种配料也有对应的 <strong>路线</strong> (route)。</p>
<p>路线是一个闭包，它在给定一个 <code>DB::Jars</code> 元组引用的情况下，返回 <code>&amp;dyn Ingredient&lt;DB&gt;</code>。</p>
<p>路线表允许我们从特定配料的 <code>IngredientIndex</code> 转到它的 <code>&amp;dyn Ingredient&lt;DB&gt;</code> trait 对象。如稍后所述，在初始化数据库时会创建路线表。</p>
<h3 id="数据库键和依赖项键"><a class="header" href="#数据库键和依赖项键">数据库键和依赖项键</a></h3>
<p><code>DatabaseKeyIndex</code> 标识了存储在特定配料中的特定值。它结合了 <a href="https://github.com/salsa-rs/salsa/blob/becaade31e6ebc58cd0505fc1ee4b8df1f39f7de/components/salsa-2022/src/routes.rs#L5-L9"><code>IngredientIndex</code></a> 与 <code>key_index</code>，其中 <code>key_index</code> 为 <code>salsa::Id</code>：</p>
<pre><code class="language-rust ignore">/// An &quot;active&quot; database key index represents a database key index
/// that is actively executing. In that case, the `key_index` cannot be
/// None.
#[derive(Copy, Clone, PartialEq, Eq, PartialOrd, Ord, Hash, Debug)]
pub struct DatabaseKeyIndex {
    pub(crate) ingredient_index: IngredientIndex,
    pub(crate) key_index: Id,
}
</code></pre>
<p><code>DependencyIndex</code> 类似，但 <code>key_index</code> 是可选的。有时当我们希望引用整个配料而不是配料中的任何特定值时，可以使用这种方法。</p>
<p>这些类型的索引用于存储配料之间的联系。例如，每个记录的值都必须跟踪其输入。这些输入被存储为 <code>DependencyIndex</code>。</p>
<p>然后我们可以做一些事情，比如通过以下途径知道“这个输入自修订 R 以来是否发生了变化”：</p>
<ul>
<li>使用配料索引查找路线并获取 <code>&amp;dyn Ingredient&lt;DB&gt;</code></li>
<li>然后对该 trait 对象调用 <code>maybe_changed_since</code> 方法</li>
</ul>
<h3 id="hasjarsdyn"><a class="header" href="#hasjarsdyn"><code>HasJarsDyn</code></a></h3>
<p>在上面的设置有一个问题。使用者的代码总是与 <code>dyn crate::Db</code> 值交互，其中 <code>crate::Db</code> 是 Jar 定义的 trait。</p>
<p><code>crate::Db</code> trait 扩展了 <code>salsa::HasJar</code>，而后者又扩展了 <code>salsa::Database</code>。</p>
<p>理想情况下，我们应该让 <code>salsa::Database</code> 扩展 <code>salsa::HasJars</code>，这是访问 Jars 数据的主要 trait 。</p>
<p>但我们不想这样做，因为 <code>HasJars</code> 定义了一个关联的类型 <code>Jars</code>，这意味着每个对 <code>dyn crate::Db</code> 的引用都必须使用类似于 <code>dyn crate::Db&lt;Jars = J&gt;</code> 
的内容来指定 Jars 类型。这将是不符合人体工程学的，但更糟糕的是，这实际上是不可能的：最终的 Jars 类型结合了来自多个 crates 的
Jars，因此任何一个单独的 Jar crate 都不知道。</p>
<p>为了解决这个问题，<code>salsa::Database</code> 实际上扩展了另一个 trait <code>HasJarsDyn</code>，它没有直接显示 <code>Jars</code> 
或配料类型，只是提供了可以对配料执行的各种方法，给出了它的 <code>IngredientIndex</code>。</p>
<p>像 <code>Ingredient&lt;DB&gt;</code> 这样的 trait 需要了解完整的 <code>DB</code> 类型。如果一个函数配料直接调用 <code>Ingredient&lt;DB&gt;</code>
上的方法，这意味着它必须完全是泛型的，并且只有在整个数据库类型可用时才在最终的 crates 中实例化。</p>
<p>我们通过 <code>HasJarsDyn</code> trait 来解决这个问题。<code>HasJarsDyn</code> trait 导出一个将“查找配料，调用方法”的步骤合并起来的方法：</p>
<pre><code class="language-rust ignore aasaaasdfijjAasdfa">/// Dyn friendly subset of HasJars
pub trait HasJarsDyn {
    fn runtime(&amp;self) -&gt; &amp;Runtime;

    fn runtime_mut(&amp;mut self) -&gt; &amp;mut Runtime;

    fn maybe_changed_after(&amp;self, input: DependencyIndex, revision: Revision) -&gt; bool;

    fn cycle_recovery_strategy(&amp;self, input: IngredientIndex) -&gt; CycleRecoveryStrategy;

    fn origin(&amp;self, input: DatabaseKeyIndex) -&gt; Option&lt;QueryOrigin&gt;;

    fn mark_validated_output(&amp;self, executor: DatabaseKeyIndex, output: DependencyIndex);

    /// Invoked when `executor` used to output `stale_output` but no longer does.
    /// This method routes that into a call to the [`remove_stale_output`](`crate::ingredient::Ingredient::remove_stale_output`)
    /// method on the ingredient for `stale_output`.
    fn remove_stale_output(&amp;self, executor: DatabaseKeyIndex, stale_output: DependencyIndex);

    /// Informs `ingredient` that the salsa struct with id `id` has been deleted.
    /// This means that `id` will not be used in this revision and hence
    /// any memoized values keyed by that struct can be discarded.
    ///
    /// In order to receive this callback, `ingredient` must have registered itself
    /// as a dependent function using
    /// [`SalsaStructInDb::register_dependent_fn`](`crate::salsa_struct::SalsaStructInDb::register_dependent_fn`).
    fn salsa_struct_deleted(&amp;self, ingredient: IngredientIndex, id: Id);

    fn fmt_index(&amp;self, index: DependencyIndex, fmt: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result;
}
</code></pre>
<p>因此，从技术上讲，要检查一个输入是否发生了变化，一种配料：</p>
<ul>
<li>在 <code>dyn Database</code> 上调用 <code>HasJarsDyn::maybe_changed_after</code></li>
<li>该方法由 <code>#[salsa::db]</code> 生成实现：
<ul>
<li>从配料索引中获取配料的路径</li>
<li>使用该路径获取该配料的 <code>&amp;dyn Ingredient</code></li>
<li>在该配料上调用 <code>maybe_changed_after</code></li>
</ul>
</li>
</ul>
<h3 id="初始化数据库"><a class="header" href="#初始化数据库">初始化数据库</a></h3>
<p>最后要讨论的是数据库是如何初始化的。<code>Storage&lt;DB&gt;</code> 的 <code>Default</code> 实现是这样的：</p>
<pre><code class="language-rust ignore">impl&lt;DB&gt; Default for Storage&lt;DB&gt;
where
    DB: HasJars,
{
    fn default() -&gt; Self {
        let mut routes = Routes::new();
        let jars = DB::create_jars(&amp;mut routes);
        Self {
            shared: Arc::new(Shared {
                jars,
                cvar: Default::default(),
            }),
            routes: Arc::new(routes),
            runtime: Runtime::default(),
        }
    }
}
</code></pre>
<p>首先，它创建一个空的 <code>Routes</code> 实例。然后调用 <code>DB::create_jars</code> 方法，此方法的实现由 <code>#[salsa::db]</code> 宏定义；它只是在每个 Jar 上调用 <code>Jar::create_jar</code> 方法：</p>
<pre><code class="language-rust ignore">            fn create_jars(routes: &amp;mut salsa::routes::Routes&lt;Self&gt;) -&gt; Self::Jars {
                (
<span class="boring">                    (
</span>                        &lt;#jar_paths as salsa::jar::Jar&gt;::create_jar(routes),
                    )*
                )
            }
</code></pre>
<p><code>create_jar</code> 这个实现由 <code>#[salsa::jar]</code> 宏生成，它只是遍历每个 Salsa 条目的所表示的类型，并要求它创建其配料</p>
<pre><code class="language-rust ignore">    quote! {
        impl&lt;'salsa_db&gt; salsa::jar::Jar&lt;'salsa_db&gt; for #jar_struct {
            type DynDb = dyn #jar_trait + 'salsa_db;

            fn create_jar&lt;DB&gt;(routes: &amp;mut salsa::routes::Routes&lt;DB&gt;) -&gt; Self
            where
                DB: salsa::storage::JarFromJars&lt;Self&gt; + salsa::storage::DbWithJar&lt;Self&gt;,
            {
<span class="boring">                (
</span>                    let #field_var_names = &lt;#field_tys as salsa::storage::IngredientsFor&gt;::create_ingredients(routes);
                )*
                Self(#(#field_var_names),*)
            }
        }
    }
</code></pre>
<p>为任何特定条目创建配料的代码由相关的宏生成（例如 <code>#[salsa::traced]</code>、<code>#[salsa::input]</code>），但它始终遵循特定的结构。</p>
<p>要创建配料，首先调用 <code>Routes::push</code>，它创建指向该配料的路线，并为其分配一个 <code>IngredientIndex</code>。然后，调用 <code>FunctionIngredient::new</code>
这样的函数来创建结构。到配料的路线被定义为给定 <code>DB::Jars</code> 的闭包，该闭包可以找到特定配料的数据。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../plumbing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../plumbing/database_and_runtime.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../plumbing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../plumbing/database_and_runtime.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
                <script type="text/javascript" src="../mermaid.min.js"></script>
                <script type="text/javascript" src="../mermaid-init.js"></script>
                <script type="text/javascript" src="../theme/pagetoc.js"></script>
        
        
    </body>
</html>
